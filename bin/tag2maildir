#! /usr/bin/env ruby
#
# @abstract Find all mail downloaded by gmvault from any given GMail account
#   and create a maildir mailbox
#
# @author Ollivier Robert <roberto@keltia.net>
#
# Read all .eml with a given tag in .meta. Generate a maildir structure
# with all .eml.
#
# @version $Id: tag2maildir,v 55513a099d0b 2012/09/23 18:10:07 roberto $

# VCS ID
MYNAME = File.basename($0)
VCS_ID = "$Id: tag2maildir,v 55513a099d0b 2012/09/23 18:10:07 roberto $"

require "date"
require "time"
require "json"
require "optparse"

# Non standard packages
#
require "mail"
require "maildir"

# Default config
#
MYBASE = ENV["HOME"] + "/Maildir"

class DataError < Exception; end

require "gmail/tag"
require "gmail/gmvault"
require "gmail/gmindex"

# Starting point
#
# @param [Array] argv
def main(argv)
  my_tag = nil
  my_base = MYBASE

  usage = <<-"EOTEXT"
Usage: #{MYNAME} [-h] -b DIR -t TAG DIR
  EOTEXT

  banner = <<-"EOTEXT"
#{MYNAME}
Revision #{VCS_ID}

#{usage}
  EOTEXT

  argv.options do |opts|
    opts.banner = banner
    opts.on("-b", "--base=DIR", "Use this directory to create mailboxes") do
      |opt_base|
      my_base = opt_base
    end
    opts.on("-d", "--debug", "Don't post directly - DEBUG mode") do
      $debug = true
    end
    opts.on("-t", "--tag=TAG", "Use the following TAG ") do
      |opt_tag|
      my_tag = opt_tag
    end
    opts.on("-h", "Help", "Display this usage") do
      puts banner
      return 255
    end
    opts.parse!
  end

  argv.options = nil
  top_dir = argv.shift

  if top_dir.nil?
    $stderr.puts("Error: directory where to load mail from must be specified")
    return(1)
  end

  if my_tag.nil?
    $stderr.puts("Error: the -t TAG option must be specified")
    return(1)
  end

  tag = nil
  Dir.chdir(top_dir) do

    tag = Tag.new(my_tag)
    maildir = Maildir.new(my_base + "/#{tag.normalize}")
    maildir.serializer = Maildir::Serializer::Mail.new
    puts("Opening maildir at #{my_base + '/' + tag.normalize}")

    index = GmIndex.new(my_base + "/#{tag.normalize}")
    start = index.last_id.to_i
    last_id = start
    puts("Opening index, last id is #{last_id}")
    puts("+: already seen / H: already in index / T: match tag / .: unseen, no match")

    added = 0
    t1 = Time.now
    begin
      Dir["**/*.meta"].each do |m|
        # load metadata
        #
        gm = GMail.new(m)

        # skip over gm_id already seen
        #
        if gm.gm_id.to_i < start
          print("+")
        else
          # not in index
          #
          if tag.match(gm.tags)
            # match, insert and put into index
            #
            if index.present?(gm.gm_id)
              print("H")
            else
              msg = maildir.add(gm.mail)
              index[gm.gm_id] = msg.key
              added += 1
              print("T")
            end
          else
            # no match
            #
            print(".")
          end
        end
        last_id = gm.gm_id.to_i
      end
      t2 = Time.now
      # Update 'last_id' field in db
      #
      index.last_id = last_id
    rescue => msg
      puts("Interrupted: #{msg}")
    end

    puts <<"EOTEXT"

Total messages in #{tag.normalize}:
  #{maildir.list(:cur).length} old, #{maildir.list(:new).length} new, #{added} added in #{t2 - t1} s.
EOTEXT
  end

  0
end # -- main

exit(main(ARGV) || 1)
